
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Examples &#8212; Book Of The Neurokraken</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Controls and Task development" href="controls.html" />
    <link rel="prev" title="Quickstart" href="quickstart.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="introduction.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/book.png" class="logo__image only-light" alt="Book Of The Neurokraken - Home"/>
    <script>document.write(`<img src="_static/book.png" class="logo__image only-dark" alt="Book Of The Neurokraken - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="introduction.html">
                    Neurokraken Introduction and Overview
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Quickstart</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Examples</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="controls.html">Controls and Task development</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration - The Neurokraken Object</a></li>
<li class="toctree-l1"><a class="reference internal" href="states.html">States and Task Progression</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Common task patterns</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="patterns.html">Common task patterns</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Peripherals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="device_library.html">Device Library - Sensors, Stimuli, Peripheral Devices, Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="cameras.html">Cameras</a></li>
<li class="toctree-l1"><a class="reference internal" href="microphones.html">Microphones</a></li>
<li class="toctree-l1"><a class="reference internal" href="arduino_custom.html">Add your own device</a></li>
<li class="toctree-l1"><a class="reference internal" href="outside_devices.html">Integrating Outside Devices</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Features</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="modes.html">Keyboard and Agent Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="UIs.html">User Interfaces (UIs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="ai_ml_cv.html">AI/ML/Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Neurokraken Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="runner_mode.html">Runner Mode</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Hardware</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="building_your_setup.html">Building Your Setup</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="for_developers.html">For Developers - Hacking the Neurokraken</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/PasseckerLab/Neurokraken" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/examples.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Examples</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#minimal">minimal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quickstart">quickstart</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imported-mode">imported mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#steering-simple">steering_simple</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#corridor-3d">corridor_3d</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#utilizing-a-3d-obj-with-blender-and-py5">Utilizing a 3D .obj with blender and py5</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#doom">DOOM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pong">pong</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#eye-tracking">eye_tracking</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#game">game</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sequence-poke">sequence_poke</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ui-examples">UI examples</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#olfactory-discrimination">olfactory_discrimination</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dot-motion">dot_motion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracked-shuttle">tracked_shuttle</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-agents">using agents</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agent-simple">agent_simple</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agent-learning">agent_learning</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cutie-examples">Cutie Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-folder-py">process_folder.py</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#live-webcam-example-py">live-webcam-example.py</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dot-motion-advanced">dot motion_advanced</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#steering-advanced">steering_advanced</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h1>
<p>You can find helpful examples within the <a class="reference external" href="https://github.com/PasseckerLab/murine-rig-development/tree/main/examples">examples folder of the neurokraken repository</a></p>
<p>These examples are ready to run and showcase the range of neurokraken’s capabilities. By default they use <code class="docutils literal notranslate"><span class="pre">mode='keyboard'</span></code> in the Neurokraken initialization allowing them to run without connected electronics. As neurokraken is built for ease-of-use running neurokraken tasks with connected physical devices, only requires changing to <code class="docutils literal notranslate"><span class="pre">mode='teensy'</span></code>, running <code class="docutils literal notranslate"><span class="pre">config2teensy.py</span></code>, and uploading the code it created in the <code class="docutils literal notranslate"><span class="pre">teensy</span></code> folder to your teensy.
For keyboard mode inputs contain an additional keys=[] list allowing you to map keyboard keys to inputs - this property is not needed outside of keyboard mode.</p>
<p>Some examples showing how to integrate external packages/utilities have additional requirements that are noted here and will have to be <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">installed</span></code> in order to run respective examples like VizDOOM and eye_tracking.</p>
<p>For examples showing how to integrate assets like images and 3D models, these assets can be found and are loaded from <code class="docutils literal notranslate"><span class="pre">examples/assets</span></code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">Alt</span> <span class="pre">+</span> <span class="pre">Q</span></code> to quit running tasks. In further developed tasks you might call <code class="docutils literal notranslate"><span class="pre">get.quit()</span></code> from a UI element (or closing of an UI window), but <code class="docutils literal notranslate"><span class="pre">Ctrl</span> <span class="pre">+</span> <span class="pre">Alt</span> <span class="pre">+</span> <span class="pre">Q</span></code> will always work, even for neurokraken tasks running in just the command line.</p>
</div>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#minimal" id="id2">minimal</a></p></li>
<li><p><a class="reference internal" href="#quickstart" id="id3">quickstart</a></p></li>
<li><p><a class="reference internal" href="#introduction" id="id4">introduction</a></p></li>
<li><p><a class="reference internal" href="#imported-mode" id="id5">imported mode</a></p></li>
<li><p><a class="reference internal" href="#steering-simple" id="id6">steering_simple</a></p></li>
<li><p><a class="reference internal" href="#corridor-3d" id="id7">corridor_3d</a></p>
<ul>
<li><p><a class="reference internal" href="#utilizing-a-3d-obj-with-blender-and-py5" id="id8">Utilizing a 3D .obj with blender and py5</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#doom" id="id9">DOOM</a></p></li>
<li><p><a class="reference internal" href="#pong" id="id10">pong</a></p></li>
<li><p><a class="reference internal" href="#eye-tracking" id="id11">eye_tracking</a></p></li>
<li><p><a class="reference internal" href="#game" id="id12">game</a></p></li>
<li><p><a class="reference internal" href="#sequence-poke" id="id13">sequence_poke</a></p></li>
<li><p><a class="reference internal" href="#ui-examples" id="id14">UI examples</a></p></li>
<li><p><a class="reference internal" href="#olfactory-discrimination" id="id15">olfactory_discrimination</a></p></li>
<li><p><a class="reference internal" href="#dot-motion" id="id16">dot_motion</a></p></li>
<li><p><a class="reference internal" href="#tracked-shuttle" id="id17">tracked_shuttle</a></p></li>
<li><p><a class="reference internal" href="#using-agents" id="id18">using agents</a></p>
<ul>
<li><p><a class="reference internal" href="#agent-simple" id="id19">agent_simple</a></p></li>
<li><p><a class="reference internal" href="#agent-learning" id="id20">agent_learning</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cutie-examples" id="id21">Cutie Examples</a></p>
<ul>
<li><p><a class="reference internal" href="#process-folder-py" id="id22">process_folder.py</a></p></li>
<li><p><a class="reference internal" href="#live-webcam-example-py" id="id23">live-webcam-example.py</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#dot-motion-advanced" id="id24">dot motion_advanced</a></p></li>
<li><p><a class="reference internal" href="#steering-advanced" id="id25">steering_advanced</a></p></li>
</ul>
</nav>
<section id="minimal">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">minimal</a><a class="headerlink" href="#minimal" title="Link to this heading">#</a></h2>
<p>We will just show the color green on a display in this state and blink an LED every 5 seconds. This example is a good starting point to understand the basic structure of Neurokraken and then modify into your task of interest.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Display</span><span class="p">,</span> <span class="n">devices</span>

<span class="n">serial_in</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">}</span>
<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;led&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">direct_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">start_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span>
                 <span class="n">display</span><span class="o">=</span><span class="n">Display</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">)</span>

<span class="c1">#------------------------- CREATE A TASK AND RUN IT -------------------------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Green</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;We will just show the color green on a display in this state and blink an LED every 5 seconds&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># store relevant variables within the state self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_last_switch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_status</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_last_switch</span> <span class="o">+</span> <span class="mi">5_000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led_status</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_status</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;led&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_last_switch</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;waiting&#39;</span><span class="p">:</span> <span class="n">Green</span><span class="p">(</span><span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;waiting&#39;</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="quickstart">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">quickstart</a><a class="headerlink" href="#quickstart" title="Link to this heading">#</a></h2>
<p>The example created in the quickstart chapter</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup configuration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">devices</span><span class="p">,</span> <span class="n">Display</span><span class="p">,</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">Microphone</span>

<span class="n">serial_in</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;light_beam&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">analog_read</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">])}</span>
<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
              <span class="s1">&#39;LED&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">direct_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">3</span><span class="p">)}</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">)</span>

<span class="c1"># task design</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Poke_for_reward</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;light_beam&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;LED&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;LED&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;poke&#39;</span><span class="p">:</span> <span class="n">Poke_for_reward</span><span class="p">(</span><span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;delay&#39;</span><span class="p">),</span>
    <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="n">State</span><span class="p">(</span><span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;poke&#39;</span><span class="p">,</span> <span class="n">max_time_s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="introduction">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>Another short introduction example</p>
<p>Here a a green rectangle is periodically appearing on the screen. Triggering a touch sensor during its appearance leads to a the delivery of a reward drink droplet from a valve.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Display</span><span class="p">,</span> <span class="n">devices</span>

<span class="n">serial_in</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_touch_sensor&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">binary_read</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])}</span>
<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_reward_valve&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">31</span><span class="p">)}</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">Display</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Touch_When_Visible</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_switch</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;my_touch_sensor&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># This sensor is currently touched, open a reward valve for 70ms, reset to not visible</span>
                <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;my_reward_valve&#39;</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_switch</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>

        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_switch</span> <span class="o">+</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="c1"># switch the visibility every 2000 milliseconds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_switch</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="p">:</span>        
            <span class="n">sketch</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">sketch</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_first_state&#39;</span><span class="p">:</span> <span class="n">Touch_When_Visible</span><span class="p">(</span><span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;my_first_state&#39;</span><span class="p">)}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="imported-mode">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">imported mode</a><a class="headerlink" href="#imported-mode" title="Link to this heading">#</a></h2>
<p>In imported mode tasks are organized in a folder containing separate files for the device configuration <code class="docutils literal notranslate"><span class="pre">config.py</span></code>, task <code class="docutils literal notranslate"><span class="pre">task.py</span></code>, and parallel code (like an UI) <code class="docutils literal notranslate"><span class="pre">launch.py</span></code>.</p>
<p>Imported mode can be run with <code class="docutils literal notranslate"><span class="pre">kraken.bat</span></code> (if you have an activateable conda environment named neurokraken) or <code class="docutils literal notranslate"><span class="pre">kraken.py</span></code>, which will provide you with a list of all tasks found within the <code class="docutils literal notranslate"><span class="pre">tasks</span></code> folder to choose from.
To run this example add a new folder with a name of your choice like <code class="docutils literal notranslate"><span class="pre">runner_mode_example</span></code> containing the respective files to <code class="docutils literal notranslate"><span class="pre">tasks</span></code>.
Runner mode can be provided with arguments for dynamic execution, like <code class="docutils literal notranslate"><span class="pre">kraken.bat</span> <span class="pre">--task</span> <span class="pre">runner_mode_example</span> <span class="pre">--keyboard</span></code> to directly execute the runner_mode_example task in keyboard mode.</p>
<p>The following example is the same as <a class="reference external" href="http://minimal.py">minimal.py</a> above, with the addition of</p>
<ul class="simple">
<li><p>a list of datapoints to be prompted upon execution, including subject options</p></li>
<li><p>a UI (<code class="docutils literal notranslate"><span class="pre">launch.py</span></code>) with a control for the task’s shown color</p></li>
</ul>
<p>You can learn more about imported mode in the <a class="reference internal" href="modes.html"><span class="doc std std-doc">modes</span></a> chapter.</p>
<blockquote>
<div><p><span>config.py</span> <!-- span to avoid auto-formatting into a hyperlink --></p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instead of being bundled with the config.py a subjects dictionary could be loaded from a .json file or remote source</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="s1">&#39;Alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">:</span> <span class="s1">&#39;female&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="s1">&#39;Beta&#39;</span><span class="p">,</span>  <span class="s1">&#39;sex&#39;</span><span class="p">:</span> <span class="s1">&#39;female&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">:</span> <span class="s1">&#39;male&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="s1">&#39;Delta&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">:</span> <span class="s1">&#39;male&#39;</span><span class="p">}]</span>

<span class="c1"># runner mode can prompt for named datapoints upon execution</span>
<span class="n">ask_for</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">]</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Display</span><span class="p">,</span> <span class="n">devices</span>
<span class="n">display</span> <span class="o">=</span> <span class="n">Display</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">))</span>

<span class="n">cameras</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>

<span class="n">serial_in</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;led&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">direct_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">start_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>
</pre></div>
</div>
<blockquote>
<div><p><span>task.py</span></p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">State</span>

<span class="n">get</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;We will just show the color on a display in this state and blink an LED every 5 seconds&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># store relevant variables within the state self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_last_switch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_status</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_last_switch</span> <span class="o">+</span> <span class="mi">5_000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led_status</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_status</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;led&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_last_switch</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;waiting&#39;</span><span class="p">:</span> <span class="n">Color</span><span class="p">(</span><span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;waiting&#39;</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p><span>launch.py</span></p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># code that would be executed just before neurokraken.run() can be included in an optional launch.py</span>
<span class="c1"># This typically covers UIs and parallel analysis/processing loops like cutie</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">py5</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sketch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">py5gui</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gui</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="k">def</span><span class="w"> </span><span class="nf">recolor_background</span><span class="p">():</span>
    <span class="n">get</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UI</span><span class="p">(</span><span class="n">Sketch</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gui</span><span class="o">.</span><span class="n">use_sketch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">gui</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;randomize background&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">on_click</span><span class="o">=</span><span class="n">recolor_background</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>     <span class="bp">self</span><span class="o">.</span><span class="n">stroke</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>     <span class="bp">self</span><span class="o">.</span><span class="n">text_size</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t_ms: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">get</span><span class="o">.</span><span class="n">time_ms</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">quitting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_sketch</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># close end the experiment when the UI window is closed</span>
        <span class="n">get</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="c1"># run the UI</span>

<span class="n">ui</span> <span class="o">=</span> <span class="n">UI</span><span class="p">()</span>
<span class="n">ui</span><span class="o">.</span><span class="n">run_sketch</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="steering-simple">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">steering_simple</a><a class="headerlink" href="#steering-simple" title="Link to this heading">#</a></h2>
<p>A simple steering task with the goal of steering a displayed shape from the center to the more rewarding side.
Once the edge has been reached a green or red delay state visual will be shown to reinforce the outcome.</p>
<p>This task utilizes a trial structure and will change the more rewarding side every 5 trials.</p>
<p>Steering task are common to investigate a wide range of decision and learning processes in rodents
<a class="reference external" href="https://elifesciences.org/articles/63711">https://elifesciences.org/articles/63711</a>
<a class="github reference external" href="https://github.com/int-brain-lab/iblrig">int-brain-lab/iblrig</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Display</span><span class="p">,</span> <span class="n">devices</span>

<span class="n">serial_in</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;steering_wheel&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">rotary_encoder</span><span class="p">(</span><span class="n">pins</span><span class="o">=</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">])</span>
<span class="p">}</span>

<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;reward_valve&#39;</span><span class="p">:</span>   <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span> 
                 <span class="n">display</span><span class="o">=</span><span class="n">Display</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">)</span>

<span class="c1">#----------------------------------- TASK -----------------------------------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="n">good_side</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">])</span>
<span class="n">background_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">steering_scaling</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Delay</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">background_color</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="o">*</span><span class="n">background_color</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Steer</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get the encoder position at the start of the state.</span>
        <span class="c1"># All our movements will be calculated as relative to this starting position. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;steering_wheel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">400</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">steering_scaling</span><span class="p">,</span> <span class="n">good_side</span><span class="p">,</span> <span class="n">background_color</span>
        <span class="n">new_position</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;steering_wheel&#39;</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">new_position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span>
        <span class="n">delta</span> <span class="o">*=</span> <span class="n">steering_scaling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">delta</span>
        
        <span class="c1"># update the current position for the next loop iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="n">new_position</span>

        <span class="n">background_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">700</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="c1"># a decision has been steered, if correct provide a reward and override the color used by the delay</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">700</span> <span class="ow">and</span> <span class="n">good_side</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="ow">and</span> <span class="n">good_side</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">):</span>
                <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
                <span class="n">background_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">stroke</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">rect_mode</span><span class="p">(</span><span class="n">sketch</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

<span class="n">last_trial_side_changed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span><span class="w"> </span><span class="nf">change_side</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">last_trial_side_changed</span><span class="p">,</span> <span class="n">good_side</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">last_trial_side_changed</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">good_side</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span> <span class="k">if</span> <span class="n">good_side</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span> <span class="k">else</span> <span class="s1">&#39;right&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Changed good side to </span><span class="si">{</span><span class="n">good_side</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">last_trial_side_changed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">])</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;steer&#39;</span><span class="p">:</span>   <span class="n">Steer</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;waiting&#39;</span><span class="p">),</span>
    <span class="s1">&#39;waiting&#39;</span><span class="p">:</span> <span class="n">Delay</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;steer&#39;</span><span class="p">,</span> <span class="n">trial_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_at_end</span><span class="o">=</span><span class="n">change_side</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="corridor-3d">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">corridor_3d</a><a class="headerlink" href="#corridor-3d" title="Link to this heading">#</a></h2>
<p>In this task the subject traverses a virtual world created in blender along a corridor track by moving a steering wheel, treading disk, hover ball or similar input.
The path leads through a central tunnel segment and once the end of the path is reached the subject will be teleported back to the start.
Stopping movement in the tunnel segment however will lead to a reward that can be collected once on the way to the end.</p>
<p>This task provides an example for:</p>
<ul class="simple">
<li><p>running a typical corridor progression task</p></li>
<li><p>A go/no-go task</p></li>
<li><p>utilizing blender created assets as part of a 3d task environment</p></li>
<li><p>positioning 3D elements and the camera in space dependent on task parameters</p></li>
</ul>
<section id="utilizing-a-3d-obj-with-blender-and-py5">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Utilizing a 3D .obj with blender and py5</a><a class="headerlink" href="#utilizing-a-3d-obj-with-blender-and-py5" title="Link to this heading">#</a></h3>
<ul>
<li><p>If you are not familiar with blender, it is an outstanding open source project that allows modeling 3D objects, state of the art movies and more.</p></li>
<li><p>The BlenderGuru Donut tutorial on youtube is a great introduction to blender</p></li>
<li><p>use whichever resources work for you to learn building a 3d .obj .</p></li>
<li><p>You can lookup workflows for specific steps, i.e. adding color textures to your model on youtube, which is full of high quality short (5 minutes) quickstarts on blender topics like texture painting <a class="reference external" href="https://youtu.be/iwWoXMWzC_c">like this video</a>.</p></li>
<li><p>.obj files you created from programs other than blender also work just the same.</p></li>
<li><p>as an example this taks uses the following world modeled out of a plane, some stretched boxes, cylinders, and applied self-drawn textures.</p></li>
<li><p><img alt="A model of a corridor within blender" src="_images/corridorBlender.png" /></p></li>
<li><p>To export your object for usage select the object in Object mode, then: <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">-&gt;</span> <span class="pre">Export</span> <span class="pre">-&gt;</span> <span class="pre">Wavefront</span> <span class="pre">(.obj)</span></code></p></li>
<li><p>Set the export parameters:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Forward</span> <span class="pre">Axis</span> <span class="pre">=</span> <span class="pre">-Z</span></code>, <code class="docutils literal notranslate"><span class="pre">Up</span> <span class="pre">Axis</span> <span class="pre">=</span> <span class="pre">-Y</span></code> with checkmarked: <code class="docutils literal notranslate"><span class="pre">Selection</span> <span class="pre">Only</span></code> and <code class="docutils literal notranslate"><span class="pre">Materials</span></code> and importantly <code class="docutils literal notranslate"><span class="pre">Materials-&gt;Path</span> <span class="pre">Mode</span></code> set to <code class="docutils literal notranslate"><span class="pre">Copy</span></code></p></li>
<li><details>
<summary>On coordinate system/axis differences between frameworks</summary>
Py5/Processing differs from from Blender by using a left hand coordinate system where the Up axis is -Y and the forward axis is -Z.
<p>A defined y and z axis still leave open 2 possible directions for x to go into depending on whether one uses a right hand (blender) or left hand (py5/Processing) coordinate system. Thus the first the python code does after <code class="docutils literal notranslate"><span class="pre">world</span> <span class="pre">=</span> <span class="pre">sketch.loadShape('world.ob')</span></code> isto flip the x axis back from the assumption of a same handed coordiante system to the right  side with <code class="docutils literal notranslate"><span class="pre">world.scale(-1,</span> <span class="pre">1,</span> <span class="pre">1)</span></code>Without this line your model would remain mirrored in x.</p>
</details>
</li>
<li><p>After the export you should have a texture image file that you already created during your blender modeling, a newly exported .obj file of your object, and a .mtl file. All 3 files need to exist together to be able to load the colored object into another framework.</p></li>
<li><p>Your export is now ready for <code class="docutils literal notranslate"><span class="pre">sketch.loadShape('filename.ob')</span></code>  and usage in py5.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Display</span><span class="p">,</span> <span class="n">devices</span>

<span class="n">serial_in</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;walking_pos&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">rotary_encoder</span><span class="p">(</span><span class="n">pins</span><span class="o">=</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">])</span>
<span class="p">}</span>

<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;reward_valve&#39;</span><span class="p">:</span>   <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">display</span> <span class="o">=</span> <span class="n">Display</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="mi">600</span><span class="p">),</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;P3D&#39;</span><span class="p">)</span>  <span class="c1"># ! Important to set the renderer to P3D for 3D</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span> 
                 <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Corridor</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get the encoder position at the start of the state. All our movements will be calculated as</span>
        <span class="c1"># relative to this starting position. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steering_scale</span> <span class="o">=</span> <span class="mf">0.025</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;walking_pos&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">465</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">recent_deltas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_speed_check</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">received_reward</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_position</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;walking_pos&#39;</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">new_position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span>
        <span class="c1"># update the current position for the next loop iteration now that you have the delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="n">new_position</span>
        <span class="c1"># scale the delta for the task</span>
        <span class="n">delta</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steering_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="c1"># prevent walking backwards out of the world</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">465</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_speed_check</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_speed_check</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recent_deltas</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recent_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">545</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="mi">585</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recent_deltas</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">received_reward</span><span class="p">:</span>
                <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">received_reward</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="mi">660</span><span class="p">:</span>
            <span class="c1"># the end was reached, go on to the next trial</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>

        <span class="c1"># set the camera field of view (these methods are documented in the py5 documentation)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">perspective</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sketch</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="n">sketch</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
 
        <span class="n">sketch</span><span class="o">.</span><span class="n">lights</span><span class="p">()</span>
        <span class="c1"># move to the current position (here the only change is in the z-axis)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">sketch</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">sketch</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="c1"># add light from the top back</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">directional_light</span><span class="p">(</span><span class="mi">126</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">directional_light</span><span class="p">(</span><span class="mi">126</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># show the world</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
         
    <span class="k">def</span><span class="w"> </span><span class="nf">on_sketch_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="c1"># assets needs to be loaded before other functions that might need them</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;assets&#39;</span> <span class="o">/</span> <span class="s1">&#39;corridor.obj&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">sketch</span><span class="o">.</span><span class="n">load_shape</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c1"># py5 uses a left hand coordinate system mirrored from blender&#39;s right hand system =&gt; flip the x axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
<span class="c1">#------------------------- TASK PROTOCOL BLOCKS AND BLOCK TRIAL STATES -------------------------</span>

<span class="n">task</span>  <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;corridor&#39;</span><span class="p">:</span> <span class="n">Corridor</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;corridor&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="doom">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">DOOM</a><a class="headerlink" href="#doom" title="Link to this heading">#</a></h2>
<p>In this task the subject plays DOOM. That’s it.
ViZDoom <a class="reference external" href="https://vizdoom.cs.put.edu.pl/">https://vizdoom.cs.put.edu.pl/</a> is a reinforcement learning environment primarily intended for research in machine visual learning and deep reinforcement learning.</p>
<p>This task provides an example for:</p>
<ul class="simple">
<li><p>Using a continous reinforcement learning environment rich in states, actions and outcomes.</p></li>
<li><p>Using a python package (vizdoom) as part of your experiment.</p>
<ul>
<li><p>Using serial_in entries with imported code - Here a joystick and a capacitive button</p></li>
</ul>
</li>
<li><p>Displaying an image/numpy array (the screen_buffer) in loop_visual()</p>
<ul>
<li><p>This is also useful for tasks purely displaying visual stimulus images or videos</p></li>
</ul>
</li>
</ul>
<p>VIZDOOOM has an extensive range of functionalities and this task only provides a starting example utilizing inputs to turn left/right, move forward/back, and fire/use.</p>
<p>VIZDOOM’s examples and  reference can be found at <a class="reference external" href="https://github.com/Farama-Foundation/ViZDoom/tree/master/examples/python">the ViZDoom examples</a> and the <a class="reference external" href="https://vizdoom.farama.org/api/python/doom_game/">VizDoom reference</a> .</p>
<p>The same approach shown in this task can be utilized to use the Neurokraken in combination with other popular reinforcement learning environments and gyms.</p>
<p>As the joystick device a PSP 2000 joystick is being used which can be connected and read as 2 <code class="docutils literal notranslate"><span class="pre">devices.analog_read()</span></code> for left/right and up/down.</p>
<p>To run this example you need to install ViZDoom into your environment with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">vizdoom</span> <span class="pre">--pre</span></code></p>
<p>If your primary display is set to vertical/portrait ViZDoom may not be able to run. Changing to a horizontal/landscape display as your primary display fixes this issue.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Display</span><span class="p">,</span> <span class="n">devices</span>

<span class="n">serial_in</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shoot&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">binary_read</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;space&#39;</span><span class="p">]),</span>
              <span class="s1">&#39;turn&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">analog_read</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]),</span>
              <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">analog_read</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">])}</span>

<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">33</span><span class="p">)}</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">Display</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">vizdoom</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">vzd</span> <span class="c1"># pip install vizdoom --pre</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">get</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DOOM</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">vzd</span><span class="o">.</span><span class="n">DoomGame</span><span class="p">()</span>

        <span class="c1"># run a specific scenario</span>
        <span class="c1"># self.game.set_doom_scenario_path(str(Path(vzd.scenarios_path) / &quot;basic.wad&quot;))</span>
        <span class="c1"># self.game.set_doom_map(&quot;map01&quot;)</span>

        <span class="c1"># render options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_screen_resolution</span><span class="p">(</span><span class="n">vzd</span><span class="o">.</span><span class="n">ScreenResolution</span><span class="o">.</span><span class="n">RES_800X600</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_screen_format</span><span class="p">(</span><span class="n">vzd</span><span class="o">.</span><span class="n">ScreenFormat</span><span class="o">.</span><span class="n">RGB24</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_hud</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span>  <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_minimal_hud</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># whether hud is enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_crosshair</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span>   <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_weapon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_decals</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span>   <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_particles</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_effects_sprites</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span>   <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_messages</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># In-game text messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_corpses</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span>   <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_render_screen_flashes</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> 

        <span class="c1"># Buttons https://vizdoom.farama.org/api/python/enums/#vizdoom.Button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_available_buttons</span><span class="p">([</span><span class="n">vzd</span><span class="o">.</span><span class="n">Button</span><span class="o">.</span><span class="n">MOVE_FORWARD</span><span class="p">,</span> <span class="n">vzd</span><span class="o">.</span><span class="n">Button</span><span class="o">.</span><span class="n">MOVE_BACKWARD</span><span class="p">,</span> <span class="n">vzd</span><span class="o">.</span><span class="n">Button</span><span class="o">.</span><span class="n">TURN_LEFT</span><span class="p">,</span> 
                                         <span class="n">vzd</span><span class="o">.</span><span class="n">Button</span><span class="o">.</span><span class="n">TURN_RIGHT</span><span class="p">,</span> <span class="n">vzd</span><span class="o">.</span><span class="n">Button</span><span class="o">.</span><span class="n">ATTACK</span><span class="p">,</span> <span class="n">vzd</span><span class="o">.</span><span class="n">Button</span><span class="o">.</span><span class="n">USE</span><span class="p">])</span>

        <span class="c1"># accessible data from the game</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_available_game_variables</span><span class="p">([</span><span class="n">vzd</span><span class="o">.</span><span class="n">GameVariable</span><span class="o">.</span><span class="n">KILLCOUNT</span><span class="p">])</span>

        <span class="c1"># We could use the built-in window with set_window_visible(True). </span>
        <span class="c1"># For this example however we are going to provide the screen buffer pixels to loop_visual</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_window_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># self.game.set_sound_enabled(True)  # sound only works if the built-in doom window were visible and in focus</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">vzd</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">PLAYER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">screen_buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span><span class="mi">800</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span> <span class="o">=</span> <span class="mi">0</span>
  
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">new_episode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># slow down the game loop executions to the framerate</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">/</span><span class="n">get</span><span class="o">.</span><span class="n">fps</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">is_episode_finished</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen_buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">screen_buffer</span> 

            <span class="n">action</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>

            <span class="n">x_mag</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;turn&#39;</span><span class="p">)</span>
            <span class="n">y_mag</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
                      
            <span class="k">if</span> <span class="n">y_mag</span> <span class="o">&lt;</span> <span class="mi">384</span><span class="p">:</span>
              <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">y_mag</span> <span class="o">&gt;</span> <span class="mi">604</span><span class="p">:</span>
              <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">x_mag</span> <span class="o">&lt;</span> <span class="mi">368</span><span class="p">:</span>
              <span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">x_mag</span> <span class="o">&gt;</span> <span class="mi">640</span><span class="p">:</span>
              <span class="n">action</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;shoot&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">action</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
              <span class="n">action</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">make_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

            <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">get_game_variable</span><span class="p">(</span><span class="n">vzd</span><span class="o">.</span><span class="n">GameVariable</span><span class="o">.</span><span class="n">KILLCOUNT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">points</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span> <span class="o">=</span> <span class="n">points</span>
               <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward&#39;</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="c1"># pass the current screen_buffer to a py5 image and display it</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">create_image_from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen_buf</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_sketch_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
       <span class="c1"># we only need to create this once before the task, not at every state on_start()</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="n">sketch</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="n">sketch</span><span class="o">.</span><span class="n">RGB</span><span class="p">)</span>

<span class="c1">#------------------------- TRAINING PROTOCOL BLOCKS AND BLOCK TRIAL STATES -------------------------</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DOOM&#39;</span><span class="p">:</span> <span class="n">DOOM</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;DOOM&#39;</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># call the game environment&#39;s close function upon neurokraken quit</span>
<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">run_at_quit</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get</span><span class="o">.</span><span class="n">current_state</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="pong">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">pong</a><a class="headerlink" href="#pong" title="Link to this heading">#</a></h2>
<p>An example pong game implementation showcasing developing a task antagonist will be added soon</p>
</section>
<section id="eye-tracking">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">eye_tracking</a><a class="headerlink" href="#eye-tracking" title="Link to this heading">#</a></h2>
<p>An eye tracking example using <a class="reference external" href="https://github.com/antoinelame/GazeTracking">GazeTracking</a> will be added soon</p>
</section>
<section id="game">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">game</a><a class="headerlink" href="#game" title="Link to this heading">#</a></h2>
<p>An example using 2D assets to create a simple game arena that can be navigated for rewards will be added soon</p>
</section>
<section id="sequence-poke">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">sequence_poke</a><a class="headerlink" href="#sequence-poke" title="Link to this heading">#</a></h2>
<p>An example where a correct sequence has to be poked for rewards will be added soon</p>
</section>
<section id="ui-examples">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">UI examples</a><a class="headerlink" href="#ui-examples" title="Link to this heading">#</a></h2>
<p>Examples showcasing the integration of different python UIs will be added soon</p>
</section>
<section id="olfactory-discrimination">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">olfactory_discrimination</a><a class="headerlink" href="#olfactory-discrimination" title="Link to this heading">#</a></h2>
<p>An example showcasing odor delivery and corresponding lick choices will be added soon</p>
</section>
<section id="dot-motion">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">dot_motion</a><a class="headerlink" href="#dot-motion" title="Link to this heading">#</a></h2>
<p>A minimal version of the advanced dot motion example will be added soon</p>
</section>
<section id="tracked-shuttle">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">tracked_shuttle</a><a class="headerlink" href="#tracked-shuttle" title="Link to this heading">#</a></h2>
<p>In this task for an open environment 2 touch-sensitive reward spouts are placed in the environment. Licking one triggers a reward and trigger receptivity at the other, encouraging subjects to rapidly and efficiently shuttle between the 2 spouts for a large number of rewards.</p>
<p>The task also integrates cutie for live tracking when setting <code class="docutils literal notranslate"><span class="pre">with_cutie</span> <span class="pre">=</span> <span class="pre">True</span></code>. Please check out the the <a class="reference internal" href="#cutie-examples"><span class="std std-ref">cutie examples</span></a> and our <a class="reference internal" href="ai_ml_cv.html"><span class="doc std std-doc">Cutie documentation</span></a> for more information on integrating cutie and live tracking into your tasks.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">with_cutie</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># ------------------------ TASK SETUP ------------------------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">devices</span><span class="p">,</span> <span class="n">Camera</span>

<span class="n">serial_in</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lick_left&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">capacitive_touch</span><span class="p">(</span><span class="n">pins</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;lick_right&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">capacitive_touch</span><span class="p">(</span><span class="n">pins</span><span class="o">=</span><span class="p">[</span><span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
<span class="p">}</span>

<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;reward_left&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
    <span class="s1">&#39;reward_right&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">41</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">cam_width</span><span class="p">,</span> <span class="n">cam_height</span> <span class="o">=</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span>
<span class="n">cameras</span> <span class="o">=</span> <span class="p">[</span><span class="n">Camera</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;camera&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">cam_width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">cam_height</span><span class="p">)]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">with_cutie</span><span class="p">:</span>
    <span class="n">cameras</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span> <span class="n">cameras</span><span class="o">=</span><span class="n">cameras</span><span class="p">,</span>
                 <span class="n">log_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">)</span>

<span class="c1">#------------------------- CREATE A TASK AND RUN IT -------------------------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>

<span class="n">threshold</span> <span class="o">=</span> <span class="mi">4000</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Lick_left</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">threshold</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s2">&quot;lick_left&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;t_lick_l&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;t_ms&#39;</span><span class="p">)</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_right&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span> 
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Lick_right</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">threshold</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s2">&quot;lick_right&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;t_lick_r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;t_ms&#39;</span><span class="p">)</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_left&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span> 
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lick_left&#39;</span><span class="p">:</span> <span class="n">Lick_left</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">60_000</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;lick_right&#39;</span><span class="p">),</span>
    <span class="s1">&#39;lick_right&#39;</span><span class="p">:</span> <span class="n">Lick_right</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">60_000</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;lick_left&#39;</span><span class="p">,</span> <span class="n">trial_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">with_cutie</span> <span class="ow">and</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">exit</span><span class="p">()</span>

<span class="c1"># ------------------------ CUTIE TRACKING AND UI ------------------------</span>

<span class="c1"># The approach is the same as in toolkit/cutie/live_webcam_example.py using the same optimizations of a </span>
<span class="c1"># parallel_predict() loop/thread and pre-created numpy- and py5 images for shared usage and performance,</span>
<span class="c1"># but now with the added context of a neurokraken task</span>

<span class="n">cutie_config_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\path\to\cloned\repository\of\Cutie\cutie\config&#39;</span>
<span class="n">reference_folder</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:\Path\to\folder\of\reference\imageJPGs\and\maskPNGs\pairs\created\with\cutie\interactivedemo&#39;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">py5</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sketch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># import the cutie processing utilities script using import_file - this approach can be used for integrating</span>
<span class="c1"># python projects saved in disparate folders.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">tools</span>
<span class="n">cutils_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;toolkit/cutie/cutils.py&#39;</span><span class="p">)</span>
<span class="n">cutils</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">import_file</span><span class="p">(</span><span class="n">cutils_path</span><span class="p">)</span>

<span class="n">cutils</span><span class="o">.</span><span class="n">create_cutie</span><span class="p">(</span><span class="n">cutie_config_path</span><span class="p">)</span>
<span class="n">cutils</span><span class="o">.</span><span class="n">load_references</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">)</span>

<span class="n">processed_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">cam_height</span><span class="p">,</span> <span class="n">cam_width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">masks</span> <span class="o">=</span>           <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">cam_height</span><span class="p">,</span> <span class="n">cam_width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parallel_predict</span><span class="p">():</span>
    <span class="c1"># cutie will keep predicting frames in this loop. In a proper experiment we might also save the created masks,</span>
    <span class="c1"># calculate information like the center of mass, and add relevant data for the experiment to get.log</span>
    <span class="k">global</span> <span class="n">processed_frame</span><span class="p">,</span> <span class="n">masks</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">quitting</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">camera</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># cutie works on RGB images =&gt; turn the frame from greyscale i.e. (720, 1280) into RGB (720, 1280, 3)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">processed_frame</span><span class="p">,</span> <span class="n">masks</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">predict_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">apply_pallete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UI</span><span class="p">(</span><span class="n">Sketch</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P2D</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">processed_frame_py5</span><span class="p">,</span> <span class="n">masks_py5</span>
        <span class="n">processed_frame_py5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RGB</span><span class="p">)</span>
        <span class="n">masks_py5</span> <span class="o">=</span>           <span class="bp">self</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RGB</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">processed_frame</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">processed_frame_py5</span><span class="p">,</span> <span class="n">masks_py5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">create_image_from_numpy</span><span class="p">(</span><span class="n">processed_frame</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">processed_frame_py5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">processed_frame_py5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_image_from_numpy</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">masks_py5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">masks_py5</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">get</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">parallel_predict</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">ui</span> <span class="o">=</span> <span class="n">UI</span><span class="p">()</span>
<span class="n">ui</span><span class="o">.</span><span class="n">run_sketch</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="using-agents">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">using agents</a><a class="headerlink" href="#using-agents" title="Link to this heading">#</a></h2>
<p>The following tasks provide examples of how to use <code class="docutils literal notranslate"><span class="pre">mode='agent'</span></code> to provide the same task that can be run by subjects in the physical space to one’s written computer code to enage with the task instead. This allows for translational research between biological and AI subjects as well as automating task testing.</p>
<ul class="simple">
<li><p>The Neurokraken object is initialized with mode=’agent’ and an agent class. This class only needs to contain a function <code class="docutils literal notranslate"><span class="pre">act(self)</span></code> that can read in the environment and make an action, and a parameter <code class="docutils literal notranslate"><span class="pre">self.act_freq</span> <span class="pre">=</span> <span class="pre">int</span></code> - how frequently the agent will execute this function.</p></li>
<li><p>While typical task code reads sensor data (<code class="docutils literal notranslate"><span class="pre">get.read_in()</span></code>) and sends out task controls (<code class="docutils literal notranslate"><span class="pre">get.send_out()</span></code>) the agent acts as the complementary opposite, accessing <code class="docutils literal notranslate"><span class="pre">get.serial_out[&lt;x&gt;][value]</span></code> to access the current state of stimulus peripherals, and updating <code class="docutils literal notranslate"><span class="pre">get.serial_in[&lt;x&gt;][value]</span></code> to provide sensor peripherals with its choices.</p>
<ul>
<li><p>The agent code can also be written to access get.log for access to historical events</p></li>
<li><p>The agent can access task visual pixel data through a numpy array that we update every visual frame from loop_visual()</p></li>
</ul>
</li>
</ul>
<section id="agent-simple">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">agent_simple</a><a class="headerlink" href="#agent-simple" title="Link to this heading">#</a></h3>
<p>agent_simple is a minimal example of using an agent in a task. A servo moves to a position left/center/right while the agent has access to 2 touch sensors and will be rewarded if he pressed the left sensor if the servo moved left and if he pressed the right sensor if the  and the agent has 2 touch sensors and will press the left one if the servo points left and the right one if the servo points right.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">devices</span>

<span class="n">serial_in</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;touch_left&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">capacitive_touch</span><span class="p">(</span><span class="n">pins</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;touch_right&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">capacitive_touch</span><span class="p">(</span><span class="n">pins</span><span class="o">=</span><span class="p">[</span><span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
<span class="p">}</span>

<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;servo&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">servo</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
    <span class="s1">&#39;reward_valve&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1">#---------------------------------- AGENT ----------------------------------</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Agent</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act_freq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># act() will be run every 2 seconds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">serial_out</span><span class="p">[</span><span class="s1">&#39;servo&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I am touching the left sensor&#39;</span><span class="p">)</span>
            <span class="n">get</span><span class="o">.</span><span class="n">serial_in</span><span class="p">[</span><span class="s1">&#39;touch_left&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6000</span>
        <span class="k">elif</span> <span class="n">get</span><span class="o">.</span><span class="n">serial_out</span><span class="p">[</span><span class="s1">&#39;servo&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">245</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I am touching the right sensor&#39;</span><span class="p">)</span>
            <span class="n">get</span><span class="o">.</span><span class="n">serial_in</span><span class="p">[</span><span class="s1">&#39;touch_right&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not touching either</span>
            <span class="n">get</span><span class="o">.</span><span class="n">serial_in</span><span class="p">[</span><span class="s1">&#39;touch_left&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">get</span><span class="o">.</span><span class="n">serial_in</span><span class="p">[</span><span class="s1">&#39;touch_right&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">()</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;agent&#39;</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span>

<span class="c1">#----------------------------------- TASK -----------------------------------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># create a numpy array to store the current frame for the agent</span>
<span class="n">get</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Intertrial</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;servo&#39;</span><span class="p">,</span> <span class="mi">127</span><span class="p">)</span>                <span class="c1"># arm in middle position</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Choice</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servo_pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">245</span><span class="p">])</span> <span class="c1"># left or right position</span>
        <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;servo&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">servo_pos</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;servo as position </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">servo_pos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">servo_pos</span> <span class="o">==</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;touch_left&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">servo_pos</span> <span class="o">==</span> <span class="mi">245</span> <span class="ow">and</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;touch_right&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
    
<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;wait&#39;</span><span class="p">:</span> <span class="n">Intertrial</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;choice&#39;</span><span class="p">),</span>
    <span class="s1">&#39;choice&#39;</span><span class="p">:</span> <span class="n">Choice</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;wait&#39;</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="agent-learning">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">agent_learning</a><a class="headerlink" href="#agent-learning" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>agent_learning is a more advanced example of an agent improving its choices with experience.</p></li>
<li><p>This example is best undestood starting with the task in the bottom (it can also be run with <code class="docutils literal notranslate"><span class="pre">mode='keyboard'</span></code>) before going to the code of the agent above.</p></li>
<li><p>In this task every 4 seconds the task changes to a random combination of display color (green/blue) and tone frequency (600Hz/1200Hz) leading to 2x2=4 stimulus combinations. The subject can make a decision to press a button or not. If the button was pressed at the combination Green/low freq or Blue/high freq, a reward will be delivered while the other 2 combinations only deliver a reward if the button was not pressed during the interval. This can be thought of as the followwing matrix of whether a button press is good:</p></li>
</ul>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>low</p></th>
<th class="head"><p>high</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>green</p></td>
<td><p>+</p></td>
<td><p>-</p></td>
</tr>
<tr class="row-odd"><td><p>blue</p></td>
<td><p>-</p></td>
<td><p>+</p></td>
</tr>
</tbody>
</table>
</div>
<ul class="simple">
<li><p>The example’s simple agent contains this press_good? matrix (initialized at 0) and will press the button if its table entry is positive.</p></li>
<li><p>The agent keeps tracks of its most recent stimuli, action choice, and the reward outcome, and then increments or decrements the table entry based on what button decision was or would have been rewarding.</p></li>
<li><p>the table will quickly develop to resemble the ideal choice matrix above.</p></li>
<li><p>The difficulty with reinforcement learning is in the implementation, so this example is a bit forced (i.e. learning frequency = choice frequency = trial frequency = 4s) to show how how a learner can be implemented in neurokraken. More powerful learner models for research are going to be more complex than this.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Display</span><span class="p">,</span> <span class="n">devices</span>

<span class="n">serial_in</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;button&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">binary_read</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
<span class="p">}</span>

<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;reward_valve&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
    <span class="s1">&#39;beep&#39;</span><span class="p">:</span>         <span class="n">devices</span><span class="o">.</span><span class="n">buzzer</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">#---------------------------------- AGENT ----------------------------------</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Agent</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act_freq</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># act() will be run 5 times per second</span>
        
        <span class="c1"># is pressing a button good in this environment? &gt;0.5 yes, &lt;0.5 no.    # ideal matrix</span>
        <span class="c1"># 1st dim green/blue/black color, 2nd dim low/high frequency           #     l  h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressgood_gb_lh</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>                                    <span class="c1"># g [[+, -],</span>
                                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]]</span>                                    <span class="c1"># b  [-, +]]</span>
     
        <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_env</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_last_choice</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># the agent will make one decision every 4 seconds, and otherwise keep the button unpressed</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>  <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_last_choice</span> <span class="o">+</span> <span class="mi">4000</span><span class="p">:</span>
            <span class="c1"># --- learn from the outcome of the last action ---</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log_rewards</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;controls&#39;</span><span class="p">][</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">]</span>
                <span class="n">recent_rewards</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">log_rewards</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span> <span class="o">-</span> <span class="mi">4100</span><span class="p">]</span>
                <span class="n">got_rewarded</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_rewards</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;my last environment, choice, reward: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_env</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">did_press</span><span class="p">,</span><span class="w"> </span><span class="n">got_rewarded</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># should pressgood for the experienced environment be increased or decreased</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="ow">and</span> <span class="n">got_rewarded</span><span class="p">:</span>         <span class="n">delta</span> <span class="o">=</span> <span class="o">+</span><span class="mf">0.1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">got_rewarded</span><span class="p">:</span>     <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="ow">and</span> <span class="n">got_rewarded</span><span class="p">:</span>     <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">got_rewarded</span><span class="p">:</span> <span class="n">delta</span> <span class="o">=</span> <span class="o">+</span><span class="mf">0.1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pressgood_gb_lh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_env</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">last_env</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">delta</span>
                <span class="c1"># Now that we learned from this experience we can set it back to 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;my new choice matrix:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressgood_gb_lh</span><span class="p">)</span>
            
            <span class="c1"># --- act based on the environment and experience ---</span>
            <span class="c1"># process the visual and audio into state spaces of 0 or 1 respectively</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">color</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">serial_out</span><span class="p">[</span><span class="s1">&#39;beep&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">700</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_env</span> <span class="o">=</span> <span class="p">[</span><span class="n">color</span><span class="p">,</span> <span class="n">audio</span><span class="p">]</span>
            
            <span class="c1"># look up experience whether in this environment a button press is good and do the learned button action</span>
            <span class="n">press_good</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressgood_gb_lh</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="n">audio</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">press_good</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Observation: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_env</span><span class="si">}</span><span class="s1"> - I am pressing the button&#39;</span><span class="p">)</span>
                <span class="n">get</span><span class="o">.</span><span class="n">serial_in</span><span class="p">[</span><span class="s1">&#39;button&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Observation: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_env</span><span class="si">}</span><span class="s1"> - I am waiting out this stimulus&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">did_press</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">t_last_choice</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">serial_in</span><span class="p">[</span><span class="s1">&#39;button&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">()</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span> 
                 <span class="n">display</span><span class="o">=</span><span class="n">Display</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;agent&#39;</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">)</span>

<span class="c1">#----------------------------------- TASK -----------------------------------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span><span class="o">,</span><span class="w"> </span><span class="nn">winsound</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># create a numpy array to store the current frame for the agent</span>
<span class="n">get</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Choice</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_was_pressed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">winsound</span><span class="o">.</span><span class="n">Beep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;beep&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
        <span class="c1"># color and tone form 2x2 combinations. 2 combinations will reward pressing the button during</span>
        <span class="c1"># the 4s state and 2 combinations (green+low, blue+high) will reward waiting out the 4s</span>
        <span class="c1"># without pressing it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_was_pressed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span>  <span class="mi">600</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span>  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">1200</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---REWARD---&#39;</span><span class="p">)</span>
                    <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">button_was_pressed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">time_ms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">&gt;</span> <span class="mi">3900</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_was_pressed</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">1200</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span>  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span>  <span class="mi">600</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---REWARD---&#39;</span><span class="p">)</span>
                    <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span>
            <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># update the frame data</span>
        <span class="n">get</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">sketch</span><span class="o">.</span><span class="n">get_np_pixels</span><span class="p">(</span><span class="n">bands</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;choice&#39;</span><span class="p">:</span> <span class="n">Choice</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;choice&#39;</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="cutie-examples">
<span id="id1"></span><h2><a class="toc-backref" href="#id21" role="doc-backlink">Cutie Examples</a><a class="headerlink" href="#cutie-examples" title="Link to this heading">#</a></h2>
<p>Additional cutie-related examples exist in Neurokraken’s toolkit/cutie folder to demonstrate usage of standalone cutie or the <code class="docutils literal notranslate"><span class="pre">toolkit/cutils.py</span></code> in a standalone way or one that can be integrated into neurokraken task</p>
<section id="process-folder-py">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">process_folder.py</a><a class="headerlink" href="#process-folder-py" title="Link to this heading">#</a></h3>
<blockquote>
<div><p>toolkit/cutie/process_folder.py</p>
</div></blockquote>
<p>This example shows using <code class="docutils literal notranslate"><span class="pre">cutils.create_cutie()</span></code>, <code class="docutils literal notranslate"><span class="pre">cutils.load_references()</span></code> and <code class="docutils literal notranslate"><span class="pre">cutils.predict_folder()</span></code> to automatically process a folder of camera frames using a couple of pre-selected reference examples.</p>
</section>
<section id="live-webcam-example-py">
<h3><a class="reference external" href="http://live-webcam-example.py">live-webcam-example.py</a><a class="headerlink" href="#live-webcam-example-py" title="Link to this heading">#</a></h3>
<blockquote>
<div><p>toolkit/cutie/live-webcam-example.py</p>
</div></blockquote>
<p>This example shows using <code class="docutils literal notranslate"><span class="pre">cutils.create_cutie()</span></code>, <code class="docutils literal notranslate"><span class="pre">cutils.load_references()</span></code> and <code class="docutils literal notranslate"><span class="pre">cutils.predict_frame()</span></code> to live process webcam frames with cutie. script contains 2 versions, one starting example in which cutie and the UI showing its results are run in the same draw loop, and one slightly longer alternative version where cutie runs in a separate thread for higher performance as it is likely to be used within actual neurokraken experiments.</p>
</section>
</section>
<section id="dot-motion-advanced">
<h2><a class="toc-backref" href="#id24" role="doc-backlink">dot motion_advanced</a><a class="headerlink" href="#dot-motion-advanced" title="Link to this heading">#</a></h2>
<p>A touchscreen task where many dots move in semirandom directions and the user has to touch the dominant target side.</p>
<p>This task makes use of python class structures to define a list of dot objects saved in <code class="docutils literal notranslate"><span class="pre">.get</span></code> for global access.
An UI allows live update to a range of variables to update the difficulty including the average angle and standard deviation around it, the speed, dot teleport probability, dot size, and total number of dots.</p>
<p>You can decrease the difficulty by reducing the teleport probability and standard deviation around the medium angle.</p>
<p>As the decision is made per click/touch on the <code class="docutils literal notranslate"><span class="pre">loop_visual()</span></code> window, it is on <code class="docutils literal notranslate"><span class="pre">loop_visual()</span></code> to save the choice for the log and <code class="docutils literal notranslate"><span class="pre">loop_main()</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">devices</span><span class="p">,</span> <span class="n">Display</span>

<span class="n">serial_in</span> <span class="o">=</span>  <span class="p">{}</span>
<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">2</span><span class="p">)}</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">,</span>
                 <span class="n">display</span><span class="o">=</span><span class="n">Display</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="mi">600</span><span class="p">)))</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>

<span class="c1"># global variables to be updated throughout the task</span>
<span class="n">get</span><span class="o">.</span><span class="n">num_dots</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">get</span><span class="o">.</span><span class="n">dots</span> <span class="o">=</span> <span class="p">[]</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Dot</span><span class="p">():</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mf">3.14159</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_teleport</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">12.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teleport</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">*</span><span class="mf">0.8</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">*</span><span class="mf">1.2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_teleport</span> <span class="o">=</span> <span class="n">p_teleport</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_teleport</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">teleport</span><span class="p">()</span>
        <span class="c1"># polar to cartesian (with r=1)</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_movement</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_movement</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
        <span class="n">dy</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">dy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">850</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">&lt;-</span><span class="mi">50</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">650</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">teleport</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">teleport</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># add a bit more space at the edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">850</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">650</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the angle to the provided mean u and standard deviation sd&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="k">if</span> <span class="n">sd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="k">if</span> <span class="n">mean</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_movement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">stroke_weight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

<span class="n">get</span><span class="o">.</span><span class="n">dots</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dot</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">3.14159</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">p_teleport</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">get</span><span class="o">.</span><span class="n">num_dots</span><span class="p">)]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Random_Dots</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># angles: left 0 pi, 2 pi, up 0.5 pi, right 1 pi, down 1.5 pi</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mf">3.14159</span>
        <span class="n">update_angle</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">made_choice</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correct_choice</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">made_choice</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_choice</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">stroke</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dot</span> <span class="ow">in</span> <span class="n">get</span><span class="o">.</span><span class="n">dots</span><span class="p">:</span>
            <span class="n">dot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">dot</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">sketch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sketch</span><span class="o">.</span><span class="n">is_mouse_pressed</span><span class="p">:</span>
            <span class="c1"># touch screen presses register as mouse clicks</span>
            <span class="k">if</span> <span class="n">sketch</span><span class="o">.</span><span class="n">mouse_x</span> <span class="o">&lt;</span> <span class="n">sketch</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">correct_choice</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">made_choice</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">sketch</span><span class="o">.</span><span class="n">mouse_x</span> <span class="o">&gt;=</span> <span class="n">sketch</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">correct_choice</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">made_choice</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_angle</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dot</span> <span class="ow">in</span> <span class="n">get</span><span class="o">.</span><span class="n">dots</span><span class="p">:</span> <span class="n">dot</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_SD</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dot</span> <span class="ow">in</span> <span class="n">get</span><span class="o">.</span><span class="n">dots</span><span class="p">:</span> <span class="n">dot</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">sd</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_probab_teleport</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dot</span> <span class="ow">in</span> <span class="n">get</span><span class="o">.</span><span class="n">dots</span><span class="p">:</span> <span class="n">dot</span><span class="o">.</span><span class="n">p_teleport</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_size</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dot</span> <span class="ow">in</span> <span class="n">get</span><span class="o">.</span><span class="n">dots</span><span class="p">:</span> <span class="n">dot</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="o">*</span><span class="mf">0.8</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="o">*</span><span class="mf">1.2</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_number_dots</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">get</span><span class="o">.</span><span class="n">dots</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dot</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_speed</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dot</span> <span class="ow">in</span> <span class="n">get</span><span class="o">.</span><span class="n">dots</span><span class="p">:</span> <span class="n">dot</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Reward</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;random_dots&#39;</span><span class="p">:</span> <span class="n">Random_Dots</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="s1">&#39;reward&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;reward&#39;</span><span class="p">:</span>  <span class="n">Reward</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;random_dots&#39;</span><span class="p">,</span> <span class="n">trial_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="n">State</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;random_dots&#39;</span><span class="p">,</span> <span class="n">trial_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># empty minimal state</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<span class="c1">#------------------------- UI -------------------------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">py5</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sketch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">py5gui</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gui</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UI</span><span class="p">(</span><span class="n">Sketch</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_title</span><span class="p">(</span><span class="s1">&#39;UI&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_move</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">gui</span><span class="o">.</span><span class="n">use_sketch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">gui</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="k">as</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">6.28318</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_angle</span><span class="p">,</span> 
                               <span class="n">on_change_while_dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;angle&#39;</span><span class="p">))</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">3.14159</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_SD</span><span class="p">,</span> 
                               <span class="n">on_change_while_dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;standard deviation&#39;</span><span class="p">))</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_speed</span><span class="p">,</span> 
                               <span class="n">on_change_while_dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;speed&#39;</span><span class="p">))</span>  
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_probab_teleport</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">on_change_while_dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;probability teleport&#39;</span><span class="p">))</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">12.5</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_size</span><span class="p">,</span> 
                               <span class="n">on_change_while_dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;dot_size&#39;</span><span class="p">))</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_number_dots</span><span class="p">,</span> 
                               <span class="n">on_change_while_dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;number of dots&#39;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">quitting</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_sketch</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">get</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="n">ui</span> <span class="o">=</span> <span class="n">UI</span><span class="p">()</span>
<span class="n">ui</span><span class="o">.</span><span class="n">run_sketch</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="steering-advanced">
<h2><a class="toc-backref" href="#id25" role="doc-backlink">steering_advanced</a><a class="headerlink" href="#steering-advanced" title="Link to this heading">#</a></h2>
<p>An advanced version of the steering task exemplifying a range of advanced features working together.</p>
<p>Here the shape has to be steered from the side to the center with the probability of the shape spawning on the left or right switching after 5 trials with &gt;75% correct choices</p>
<p>Additions include:</p>
<ul class="simple">
<li><p>GUI with override buttons and live data (time, wheel position, side spawn probabilities…)</p></li>
<li><p>Pulse clocks for time alignment with external devices</p></li>
<li><p>Rotary encoder extension with a control to reset to 0</p></li>
<li><p>autostart=False with experiment start and stop triggered from the UI</p></li>
<li><p>splitting state sequence after choice</p></li>
<li><p>manual trial log additions and access</p></li>
<li><p>performance and trial check to decide whether the probability should be changed</p></li>
<li><p>self-made image used for the steered shape</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken</span><span class="w"> </span><span class="kn">import</span> <span class="n">Neurokraken</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.configurators</span><span class="w"> </span><span class="kn">import</span> <span class="n">Display</span><span class="p">,</span> <span class="n">devices</span>

<span class="n">serial_in</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;clock_100ms&#39;</span><span class="p">:</span>    <span class="n">devices</span><span class="o">.</span><span class="n">pulse_clock</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">change_periods_ms</span><span class="o">=</span> <span class="mi">100</span><span class="p">),</span>
    <span class="s1">&#39;clock_1s&#39;</span><span class="p">:</span>       <span class="n">devices</span><span class="o">.</span><span class="n">pulse_clock</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">change_periods_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
    <span class="s1">&#39;steering_wheel&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">rotary_encoder</span><span class="p">(</span><span class="n">pins</span><span class="o">=</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">])</span>
<span class="p">}</span>

<span class="n">serial_out</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;reward_valve&#39;</span><span class="p">:</span>   <span class="n">devices</span><span class="o">.</span><span class="n">timed_on</span><span class="p">(</span><span class="n">pin</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
    <span class="s1">&#39;steering_wheel&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="o">.</span><span class="n">rotary_encoder</span><span class="p">(</span><span class="n">pins</span><span class="o">=</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">controls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># ! same name but controls=True</span>
<span class="p">}</span>

<span class="n">nk</span> <span class="o">=</span> <span class="n">Neurokraken</span><span class="p">(</span><span class="n">serial_in</span><span class="o">=</span><span class="n">serial_in</span><span class="p">,</span> <span class="n">serial_out</span><span class="o">=</span><span class="n">serial_out</span><span class="p">,</span>
                 <span class="n">display</span><span class="o">=</span><span class="n">Display</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;keyboard&#39;</span><span class="p">,</span> <span class="n">autostart</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neurokraken.controls</span><span class="w"> </span><span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1">#----------------------------------- TASK -----------------------------------</span>

<span class="n">probability_left_spawn</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">valve_open_t_ms</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">steering_scaling</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Delay</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Timeout</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>        
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Reward</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">valve_open_t_ms</span>
        <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="n">valve_open_t_ms</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Steer</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get the encoder position at the start of the state. All our movements will be </span>
        <span class="c1"># calculated as relative to this starting position. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;steering_wheel&#39;</span><span class="p">)</span>

        <span class="k">global</span> <span class="n">probability_left_spawn</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">probability_left_spawn</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">600</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">loop_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;When the shape was moved more than 200 from its starting position and is at the center,</span>
<span class="sd">        the State is completed and will move on to next_state 0. Otherwise if the shape was steered</span>
<span class="sd">        to the edge it will move on to next_state 1&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">steering_scaling</span>
        <span class="n">new_position</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;steering_wheel&#39;</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">new_position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span>
        <span class="n">delta</span> <span class="o">*=</span> <span class="n">steering_scaling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">delta</span>
        
        <span class="c1"># update the current position for the next loop iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="n">new_position</span>

        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span>
        <span class="c1"># timeout condition</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_visual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">image_mode</span><span class="p">(</span><span class="n">sketch</span><span class="o">.</span><span class="n">CENTER</span><span class="p">)</span>
        <span class="n">sketch</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">texture</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_sketch_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sketch</span><span class="p">):</span>
        <span class="c1"># the texture should be loaded before other functions might need it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texture</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;assets&#39;</span> <span class="o">/</span> <span class="s1">&#39;steering_texture.png&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texture</span> <span class="o">=</span> <span class="n">sketch</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">texture</span><span class="p">))</span>
        
<span class="c1">#------------------------- SCHEDULE -------------------------</span>

<span class="c1"># To schedule task changes we write a function to provide as run_post_trial. (or as the final states&#39; run_at_end=.)</span>
<span class="c1"># Checking State&#39;s signature for a run_at_end-function it receives a reference to the current state</span>
<span class="c1"># and whether it was sucessfully finished (or timed out).</span>
<span class="k">def</span><span class="w"> </span><span class="nf">switch_side_probability_if_performant</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the recent 5 trials to determine the performance. If the subject </span>
<span class="sd">    performs correctly (rewarded) in more than 75% of the last 5 trials, the probability of the</span>
<span class="sd">    stimulus appearing on the left side (probability_left_spawn) is adjusted.</span>
<span class="sd">    The adjustment alternates the probability between 0.2 and 0.8.&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">probability_left_spawn</span>
    <span class="n">n_last_trials</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">last_n_trials</span> <span class="o">=</span> <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="n">n_last_trials</span><span class="p">:]</span>
    <span class="c1"># don&#39;t test if too few trials have been performed or a switch already took place recently.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">n_last_trials</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">num_recent_switches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">last_n_trials</span> <span class="k">if</span> <span class="s1">&#39;switched_side&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">num_recent_switches</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">num_rewarded</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">last_n_trials</span> <span class="k">if</span> <span class="s1">&#39;rewarded&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span> <span class="c1"># added by log_reward() beneath</span>
    <span class="n">ratio_correct</span> <span class="o">=</span> <span class="n">num_rewarded</span> <span class="o">/</span> <span class="n">n_last_trials</span>
    <span class="k">if</span> <span class="n">ratio_correct</span> <span class="o">&gt;</span> <span class="mf">0.75</span><span class="p">:</span>
        <span class="n">probability_left_spawn</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="k">if</span> <span class="n">probability_left_spawn</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="mf">0.8</span>
        <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;switched_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probability_left_spawn</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;switched to new left spawn probabiltiy: </span><span class="si">{</span><span class="n">probability_left_spawn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># We can also provide a run_at_start function to states</span>
<span class="k">def</span><span class="w"> </span><span class="nf">log_reward</span><span class="p">():</span>
    <span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;trials&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;rewarded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#------------------------- TASK PROTOCOL -------------------------</span>

<span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;waiting&#39;</span><span class="p">:</span> <span class="n">Delay</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;steer&#39;</span><span class="p">),</span>
    <span class="s1">&#39;steer&#39;</span><span class="p">:</span>   <span class="n">Steer</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;reward&#39;</span><span class="p">:</span>  <span class="n">Reward</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;waiting&#39;</span><span class="p">,</span>
                      <span class="n">run_at_start</span><span class="o">=</span><span class="n">log_reward</span><span class="p">,</span>
                      <span class="n">trial_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">Timeout</span><span class="p">(</span><span class="n">max_time_s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;waiting&#39;</span><span class="p">,</span>
                       <span class="n">trial_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">nk</span><span class="o">.</span><span class="n">load_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">run_post_trial</span><span class="o">=</span><span class="n">switch_side_probability_if_performant</span><span class="p">)</span>

<span class="c1">#------------------------- ADD A SMALL UI -------------------------</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py5</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sketch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">py5gui</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gui</span>

<span class="k">def</span><span class="w"> </span><span class="nf">override_reward</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">valve_open_t_ms</span>
    <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;reward_valve&#39;</span><span class="p">,</span> <span class="n">valve_open_t_ms</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UI</span><span class="p">(</span><span class="n">Sketch</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_title</span><span class="p">(</span><span class="s1">&#39;UI&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_move</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">630</span><span class="p">)</span>
                
        <span class="k">with</span> <span class="n">gui</span><span class="o">.</span><span class="n">Col</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="mi">270</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="k">as</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;override single reward&#39;</span><span class="p">,</span><span class="n">on_click</span><span class="o">=</span><span class="n">override_reward</span><span class="p">))</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;start task&#39;</span><span class="p">,</span> <span class="n">on_click</span><span class="o">=</span><span class="n">get</span><span class="o">.</span><span class="n">start</span><span class="p">))</span> <span class="c1"># as we set autostart=False we</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;stop task&#39;</span><span class="p">,</span> <span class="n">on_click</span><span class="o">=</span><span class="n">get</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>   <span class="c1"># have to manually start the task</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">reset_wheel</span><span class="p">():</span> <span class="n">get</span><span class="o">.</span><span class="n">send_out</span><span class="p">(</span><span class="s1">&#39;steering_wheel&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">col</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;reset wheel pos&#39;</span><span class="p">,</span> <span class="n">on_click</span><span class="o">=</span><span class="n">reset_wheel</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">probability_left_spawn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>     <span class="bp">self</span><span class="o">.</span><span class="n">stroke</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_size</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="c1"># show some general task information, with \n to start newlines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;time (ms): </span><span class="si">{</span><span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;t_ms&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> 
                  <span class="sa">f</span><span class="s1">&#39;wheel pos: </span><span class="si">{</span><span class="n">get</span><span class="o">.</span><span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;steering_wheel&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;probability_left_spawn: </span><span class="si">{</span><span class="n">probability_left_spawn</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="sa">f</span><span class="s1">&#39;number of trials: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">get</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;trials&quot;</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">get</span><span class="o">.</span><span class="n">quitting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_sketch</span><span class="p">()</span> <span class="c1"># end the UI if the experiment is quitting from its side</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># end the experiment when the UI window is closed</span>
        <span class="n">get</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="c1">#------------------------- START THE UI AND TASK -------------------------</span>

<span class="n">ui</span> <span class="o">=</span> <span class="n">UI</span><span class="p">()</span>
<span class="n">ui</span><span class="o">.</span><span class="n">run_sketch</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">nk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="quickstart.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Quickstart</p>
      </div>
    </a>
    <a class="right-next"
       href="controls.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Controls and Task development</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#minimal">minimal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quickstart">quickstart</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imported-mode">imported mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#steering-simple">steering_simple</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#corridor-3d">corridor_3d</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#utilizing-a-3d-obj-with-blender-and-py5">Utilizing a 3D .obj with blender and py5</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#doom">DOOM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pong">pong</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#eye-tracking">eye_tracking</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#game">game</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sequence-poke">sequence_poke</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ui-examples">UI examples</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#olfactory-discrimination">olfactory_discrimination</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dot-motion">dot_motion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracked-shuttle">tracked_shuttle</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-agents">using agents</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agent-simple">agent_simple</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#agent-learning">agent_learning</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cutie-examples">Cutie Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#process-folder-py">process_folder.py</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#live-webcam-example-py">live-webcam-example.py</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dot-motion-advanced">dot motion_advanced</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#steering-advanced">steering_advanced</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Neuroraken developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright CC0 (2025).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>